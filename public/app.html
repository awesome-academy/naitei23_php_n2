<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Co-working Booking UI (Single file)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #0b1020; color: #e8ecff; }
    .card { background: #121a33; border: 1px solid rgba(255,255,255,0.08); }
    .muted { color: rgba(232,236,255,0.75); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .pointer { cursor: pointer; }
    .badge-soft { background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.14); }
    .table { --bs-table-bg: transparent; --bs-table-color: #e8ecff; }
    .table td, .table th { border-color: rgba(255,255,255,0.10) !important; }
    .nav-pills .nav-link.active { background: #4c6fff; }
    .btn-primary { background: #4c6fff; border-color: #4c6fff; }
    .form-control, .form-select { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.14); color: #e8ecff; }
    .form-control::placeholder { color: rgba(232,236,255,0.45); }
    .form-control:focus, .form-select:focus { box-shadow: none; border-color: rgba(76,111,255,0.7); }
    .hr { height: 1px; background: rgba(255,255,255,0.10); }
    .smallcaps { letter-spacing: .08em; text-transform: uppercase; font-size: .78rem; color: rgba(232,236,255,0.7); }
    .toast-container { position: fixed; top: 16px; right: 16px; z-index: 9999; }
    canvas { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.10); border-radius: 12px; }
  </style>
</head>
<body>
  <div class="toast-container" id="toastRoot"></div>

  <div class="container py-4">
    <!-- Header -->
    <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-3">
      <div>
        <div class="h3 mb-0">Workspace Booking Dashboard</div>
        <div class="muted" id="userInfo">Loading...</div>
      </div>
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <button class="btn btn-sm btn-outline-light" id="btnMe">Refresh /me</button>
        <button class="btn btn-sm btn-outline-info" id="btnProfile">Profile</button>
        <button class="btn btn-sm btn-outline-warning" id="btnLogout">Logout</button>
      </div>
    </div>

    <!-- Nav -->
    <ul class="nav nav-pills gap-2 mb-3" id="mainTabs">
      <li class="nav-item"><a class="nav-link active" href="#" data-tab="tabPublic">Public Search</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-tab="tabMyBookings">My Bookings</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-tab="tabMyPayments">My Payments</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-tab="tabManager">Manager</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-tab="tabOwner">Owner</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-tab="tabAdmin">Admin</a></li>
    </ul>

    <!-- Tabs content -->

    <!-- Public Search -->
    <div class="card p-3 mb-3" id="tabPublic">
      <div class="d-flex align-items-center justify-content-between">
        <div class="h5 mb-0">Search Spaces</div>
        <button class="btn btn-sm btn-outline-light" id="btnSearch">Search</button>
      </div>
      <div class="muted mb-3">Supports optional <span class="mono">start_time/end_time</span> availability filter</div>

      <div class="row g-2">
        <div class="col-lg-3">
          <input class="form-control" id="q" placeholder="q (name/venue/address)" />
        </div>
        <div class="col-lg-2">
          <input class="form-control" id="city" placeholder="city (e.g. Hanoi)" />
        </div>
        <div class="col-lg-2">
          <input class="form-control" id="min_price" placeholder="min_price" />
        </div>
        <div class="col-lg-2">
          <input class="form-control" id="max_price" placeholder="max_price" />
        </div>
        <div class="col-lg-3">
          <select class="form-select" id="per_page">
            <option value="10">per_page 10</option>
            <option value="15">per_page 15</option>
            <option value="20">per_page 20</option>
            <option value="50">per_page 50</option>
          </select>
        </div>

        <div class="col-lg-3">
          <label class="smallcaps mb-1">start_time</label>
          <input type="datetime-local" class="form-control" id="start_time" />
        </div>
        <div class="col-lg-3">
          <label class="smallcaps mb-1">end_time</label>
          <input type="datetime-local" class="form-control" id="end_time" />
        </div>
        <div class="col-lg-6 d-flex align-items-end gap-2">
          <div class="muted">Tip: để trống start/end = behavior cũ (không filter availability).</div>
        </div>
      </div>

      <div class="hr my-3"></div>
      <div id="searchMeta" class="muted mb-2"></div>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Space</th>
              <th>Venue</th>
              <th>City</th>
              <th>Capacity</th>
              <th>Prices</th>
              <th class="text-end">Action</th>
            </tr>
          </thead>
          <tbody id="searchRows"></tbody>
        </table>
      </div>
    </div>

    <!-- My Bookings -->
    <div class="card p-3 mb-3 d-none" id="tabMyBookings">
      <div class="d-flex align-items-center justify-content-between">
        <div class="h5 mb-0">My Bookings</div>
        <button class="btn btn-sm btn-outline-light" id="btnLoadMyBookings">Reload</button>
      </div>
      <div class="muted mb-2">Rules: cancel before payment success; pay when status is <span class="mono">awaiting_payment/confirmed</span>.</div>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Status</th>
              <th>Time</th>
              <th>Total</th>
              <th>Space / Venue</th>
              <th class="text-end">Action</th>
            </tr>
          </thead>
          <tbody id="myBookingRows"></tbody>
        </table>
      </div>
    </div>

    <!-- My Payments -->
    <div class="card p-3 mb-3 d-none" id="tabMyPayments">
      <div class="d-flex align-items-center justify-content-between">
        <div class="h5 mb-0">My Payments</div>
        <button class="btn btn-sm btn-outline-light" id="btnLoadMyPayments">Reload</button>
      </div>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Booking</th>
              <th>Amount</th>
              <th>Method</th>
              <th>Status</th>
              <th>Paid at</th>
            </tr>
          </thead>
          <tbody id="myPaymentRows"></tbody>
        </table>
      </div>
    </div>

    <!-- Manager -->
    <div class="card p-3 mb-3 d-none" id="tabManager">
      <div class="h5 mb-0">Manager Dashboard</div>

      <ul class="nav nav-pills gap-2 my-3" id="managerTabs">
        <li class="nav-item"><a class="nav-link active" href="#" data-manager-tab="managerManagedVenues">Managed Venues</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-manager-tab="managerBookings">Pending Bookings</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-manager-tab="managerSpaces">Spaces (Read-only)</a></li>
      </ul>

      <!-- Manager Managed Venues Sub-tab -->
      <div id="managerManagedVenues">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="muted">Venues you manage</div>
          <button class="btn btn-sm btn-outline-light" id="btnLoadManagerVenues">Reload</button>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>City</th>
                <th>Status</th>
                <th>Spaces</th>
              </tr>
            </thead>
            <tbody id="managerVenueRows">
              <tr><td colspan="5" class="text-center muted">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Manager Bookings Sub-tab -->
      <div class="d-none" id="managerBookings">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="muted">Pending bookings in managed venues</div>
          <button class="btn btn-sm btn-outline-light" id="btnLoadManagerBookings">Reload</button>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Status</th>
                <th>User</th>
                <th>Time</th>
                <th>Space / Venue</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="managerBookingRows"></tbody>
          </table>
        </div>
      </div>

      <!-- Manager Spaces Sub-tab (Read-only) -->
      <div class="d-none" id="managerSpaces">
        <div class="muted mb-2">Spaces in your managed venues (read-only)</div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name & Type</th>
                <th>Venue</th>
                <th>Capacity</th>
                <th>Prices</th>
                <th>Time</th>
              </tr>
            </thead>
            <tbody id="managerSpaceRows">
              <tr><td colspan="6" class="text-center muted">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Owner -->
    <div class="card p-3 mb-3 d-none" id="tabOwner">
      <div class="h5 mb-0">Owner Dashboard</div>

      <ul class="nav nav-pills gap-2 my-3" id="ownerTabs">
        <li class="nav-item"><a class="nav-link active" href="#" data-owner-tab="ownerBookings">Bookings</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-owner-tab="ownerVenues">My Venues</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-owner-tab="ownerSpaces">Spaces</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-owner-tab="ownerManagers">Managers</a></li>
      </ul>

      <!-- Owner Bookings Sub-tab -->
      <div id="ownerBookings">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="muted">Owner endpoints: list + confirm/reject</div>
          <button class="btn btn-sm btn-outline-light" id="btnLoadOwnerBookings">Reload</button>
        </div>

        <div class="row g-2 mb-2">
          <div class="col-lg-3">
            <input class="form-control" id="owner_status" placeholder="status (optional)" />
          </div>
          <div class="col-lg-2">
            <input class="form-control" id="owner_venue_id" placeholder="venue_id (optional)" />
          </div>
          <div class="col-lg-2">
            <input class="form-control" id="owner_space_id" placeholder="space_id (optional)" />
          </div>
          <div class="col-lg-2">
            <input type="date" class="form-control" id="owner_start_date" />
          </div>
          <div class="col-lg-2">
            <input type="date" class="form-control" id="owner_end_date" />
          </div>
          <div class="col-lg-1 d-grid">
            <button class="btn btn-outline-light" id="btnOwnerFilter">Go</button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Status</th>
                <th>User</th>
                <th>Time</th>
                <th>Space / Venue</th>
                <th>Total</th>
                <th class="text-end">Action</th>
              </tr>
            </thead>
            <tbody id="ownerBookingRows"></tbody>
          </table>
        </div>
      </div>

      <!-- Owner Venues Sub-tab -->
      <div class="d-none" id="ownerVenues">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="muted">Manage your venues</div>
          <button class="btn btn-sm btn-primary" id="btnAddVenue">+ Add Venue</button>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>City</th>
                <th>Status</th>
                <th>Spaces</th>
                <th class="text-end">Action</th>
              </tr>
            </thead>
            <tbody id="ownerVenueRows">
              <tr><td colspan="6" class="text-center muted">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Owner Spaces Sub-tab -->
      <div class="d-none" id="ownerSpaces">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div>
            <button class="btn btn-sm btn-outline-secondary" id="btnBackToVenues">← Back to Venues</button>
            <span class="muted ms-2" id="spacesVenueTitle">Select a venue first</span>
          </div>
          <button class="btn btn-sm btn-primary" id="btnAddSpace" disabled>+ Add Space</button>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name & Type</th>
                <th>Venue</th>
                <th>Capacity</th>
                <th>Prices</th>
                <th>Time</th>
                <th class="text-end">Action</th>
              </tr>
            </thead>
            <tbody id="ownerSpaceRows">
              <tr><td colspan="7" class="text-center muted">Select a venue from "My Venues" tab</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Owner Managers Sub-tab -->
      <div class="d-none" id="ownerManagers">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div>
            <span class="muted" id="managersVenueTitle">Select a venue first</span>
          </div>
          <div class="d-flex gap-2">
            <input type="email" class="form-control form-control-sm" id="inputManagerEmail" placeholder="manager@example.com" style="width:250px" disabled>
            <button class="btn btn-sm btn-primary" id="btnAddManager" disabled>+ Add Manager</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th class="text-end">Action</th>
              </tr>
            </thead>
            <tbody id="ownerManagerRows">
              <tr><td colspan="5" class="text-center muted">Select a venue from "My Venues" tab</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Admin -->
    <div class="card p-3 mb-3 d-none" id="tabAdmin">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div class="h5 mb-0">Admin Dashboard</div>
        <div class="d-flex gap-2 align-items-center">
          <input type="month" class="form-control form-control-sm" id="admin_month" style="width: 160px;">
          <button class="btn btn-sm btn-outline-light" id="btnAdminRefresh">Refresh</button>
        </div>
      </div>

      <ul class="nav nav-pills gap-2 my-3" id="adminTabs">
        <li class="nav-item"><a class="nav-link active" href="#" data-admin-tab="adminStats">Statistics</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-admin-tab="adminBookings">Bookings</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-admin-tab="adminVenues">Venues</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-admin-tab="adminPayments">Payments</a></li>
      </ul>

      <!-- Admin Stats -->
      <div id="adminStats">
        <div class="row g-2">
          <div class="col-lg-3"><div class="card p-3"><div class="smallcaps">Total users</div><div class="h4 mb-0" id="st_total_users">-</div></div></div>
          <div class="col-lg-3"><div class="card p-3"><div class="smallcaps">New users (month)</div><div class="h4 mb-0" id="st_new_users">-</div></div></div>
          <div class="col-lg-3"><div class="card p-3"><div class="smallcaps">Bookings (month)</div><div class="h4 mb-0" id="st_bookings_month">-</div></div></div>
          <div class="col-lg-3"><div class="card p-3"><div class="smallcaps">Revenue (month)</div><div class="h4 mb-0" id="st_rev_month">-</div></div></div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-lg-6">
            <div class="card p-3">
              <div class="d-flex align-items-center justify-content-between">
                <div class="smallcaps">Bookings by status (month)</div>
                <span class="badge badge-soft" id="st_month">-</span>
              </div>
              <canvas id="chartStatus" width="600" height="220"></canvas>
              <div class="muted mt-2">Chart data from <span class="mono">/api/admin/statistics</span>.{index=8}</div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card p-3">
              <div class="smallcaps mb-2">Venue summary</div>
              <div class="d-flex flex-wrap gap-2">
                <span class="badge badge-soft">Total venues: <span id="st_total_venues">-</span></span>
                <span class="badge badge-soft">Pending: <span id="st_pending_venues">-</span></span>
                <span class="badge badge-soft">Approved: <span id="st_approved_venues">-</span></span>
                <span class="badge badge-soft">Total revenue: <span id="st_total_revenue">-</span></span>
              </div>
              <div class="muted mt-2">Pending venues = badge alert cho moderation.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin Bookings -->
      <div class="d-none" id="adminBookings">
        <div class="muted mb-2">Endpoint: <span class="mono">GET /api/admin/bookings</span> (filters + pagination).{index=9}</div>

        <div class="row g-2 mb-2">
          <div class="col-lg-2"><input class="form-control" id="ab_status" placeholder="status" /></div>
          <div class="col-lg-2"><input type="date" class="form-control" id="ab_start_date" /></div>
          <div class="col-lg-2"><input type="date" class="form-control" id="ab_end_date" /></div>
          <div class="col-lg-2"><input class="form-control" id="ab_user_id" placeholder="user_id" /></div>
          <div class="col-lg-2"><input class="form-control" id="ab_venue_id" placeholder="venue_id" /></div>
          <div class="col-lg-2"><input class="form-control" id="ab_search" placeholder="search (name/email/space)" /></div>
          <div class="col-lg-12 d-flex gap-2">
            <button class="btn btn-outline-light" id="btnAdminBookings">Load</button>
            <div class="muted" id="ab_meta"></div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>ID</th><th>Status</th><th>User</th><th>Time</th><th>Space/Venue</th><th>Total</th>
              </tr>
            </thead>
            <tbody id="ab_rows"></tbody>
          </table>
        </div>
      </div>

      <!-- Admin Venues -->
      <div class="d-none" id="adminVenues">
        <div class="muted mb-2">Moderation endpoints: list pending + approve/reject/block/unblock.{index=10}</div>

        <div class="row g-2 mb-2">
          <div class="col-lg-3">
            <select class="form-select" id="av_status">
              <option value="pending">pending</option>
              <option value="approved">approved</option>
              <option value="rejected">rejected</option>
              <option value="blocked">blocked</option>
              <option value="">(all)</option>
            </select>
          </div>
          <div class="col-lg-9 d-flex gap-2">
            <button class="btn btn-outline-light" id="btnAdminVenues">Load</button>
            <div class="muted" id="av_meta"></div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>ID</th><th>Name</th><th>City</th><th>Status</th><th>Created</th><th class="text-end">Action</th>
              </tr>
            </thead>
            <tbody id="av_rows"></tbody>
          </table>
        </div>
      </div>

      <!-- Admin Payments -->
      <div class="d-none" id="adminPayments">
        <div class="muted mb-2">Endpoint: <span class="mono">GET /api/admin/payments</span> (filters).{index=11}</div>

        <div class="row g-2 mb-2">
          <div class="col-lg-2"><input class="form-control" id="ap_status" placeholder="status" /></div>
          <div class="col-lg-2"><input class="form-control" id="ap_method" placeholder="payment_method" /></div>
          <div class="col-lg-2"><input class="form-control" id="ap_user_id" placeholder="user_id" /></div>
          <div class="col-lg-2"><input class="form-control" id="ap_venue_id" placeholder="venue_id" /></div>
          <div class="col-lg-2"><input class="form-control" id="ap_space_id" placeholder="space_id" /></div>
          <div class="col-lg-2 d-grid"><button class="btn btn-outline-light" id="btnAdminPayments">Load</button></div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>ID</th><th>Booking</th><th>Amount</th><th>Method</th><th>Status</th><th>Paid at</th><th>User</th><th>Venue</th>
              </tr>
            </thead>
            <tbody id="ap_rows"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <!-- Booking modal -->
  <div class="modal fade" id="modalBook" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content text-light" style="background:#121a33;border:1px solid rgba(255,255,255,0.10);">
        <div class="modal-header">
          <h5 class="modal-title">Create Booking</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="muted mb-2">POST <span class="mono">/api/bookings</span></div>
          <div class="row g-2">
            <div class="col-lg-4">
              <label class="smallcaps mb-1">space_id</label>
              <input id="book_space_id" class="form-control mono" readonly />
            </div>
            <div class="col-lg-4">
              <label class="smallcaps mb-1">start_time</label>
              <input id="book_start" type="datetime-local" class="form-control" />
            </div>
            <div class="col-lg-4">
              <label class="smallcaps mb-1">end_time</label>
              <input id="book_end" type="datetime-local" class="form-control" />
            </div>
            <div class="col-lg-12">
              <label class="smallcaps mb-1">note</label>
              <input id="book_note" class="form-control" placeholder="optional" />
            </div>
          </div>
          <div class="muted mt-2" id="book_hint"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-primary" id="btnBookSubmit">Create</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pay modal -->
  <div class="modal fade" id="modalPay" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-light" style="background:#121a33;border:1px solid rgba(255,255,255,0.10);">
        <div class="modal-header">
          <h5 class="modal-title">Pay Booking</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="muted mb-2">POST <span class="mono">/api/payments</span></div>
          <div class="row g-2">
            <div class="col-12">
              <label class="smallcaps mb-1">booking_id</label>
              <input id="pay_booking_id" class="form-control mono" readonly />
            </div>
            <div class="col-12">
              <label class="smallcaps mb-1">payment_method</label>
              <select id="pay_method" class="form-select">
                <option value="cash" style="color: #111; background: #fff;">cash</option>
                <option value="bank_transfer" style="color: #111; background: #fff;">bank_transfer</option>
                <option value="e_wallet" style="color: #111; background: #fff;">e_wallet</option>
                <option value="credit_card" style="color: #111; background: #fff;">credit_card</option>
              </select>
            </div>
          </div>
          <div class="muted mt-2">Rule: chỉ pay khi <span class="mono">awaiting_payment/confirmed</span>.{index=12}</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-primary" id="btnPaySubmit">Pay</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ====== CONFIG / STATE ======
    const CONFIG = {
      TOKEN_KEY: 'workspace_token',
      USER_KEY: 'workspace_user',
      BASE_URL_KEY: 'workspace_base_url',
    };

    const BOOKING_STATUS_COLORS = {
      'pending_confirmation': 'warning',
      'awaiting_payment': 'info',
      'confirmed': 'success',
      'paid': 'success',
      'cancelled': 'danger',
      'rejected': 'danger',
      'completed': 'secondary',
    };

    const VENUE_STATUS_COLORS = {
      'pending': 'warning',
      'approved': 'success',
      'rejected': 'danger',
      'blocked': 'dark'
    };

    function getBaseUrl() {
      return (localStorage.getItem(CONFIG.BASE_URL_KEY) || '').trim();
    }
    function setBaseUrl(v) {
      localStorage.setItem(CONFIG.BASE_URL_KEY, (v || '').trim());
    }

    function getToken() { return localStorage.getItem(CONFIG.TOKEN_KEY); }
    function setToken(t) { localStorage.setItem(CONFIG.TOKEN_KEY, t); }
    function clearAuth() { localStorage.removeItem(CONFIG.TOKEN_KEY); localStorage.removeItem(CONFIG.USER_KEY); }

    function getUser() {
      const raw = localStorage.getItem(CONFIG.USER_KEY);
      try { return raw ? JSON.parse(raw) : null; } catch { return null; }
    }
    function setUser(u) { localStorage.setItem(CONFIG.USER_KEY, JSON.stringify(u)); }

    function hasRole(role) {
      const u = getUser();
      const roles = (u && (u.roles || u.role || [])) || [];
      return Array.isArray(roles) ? roles.includes(role) : (roles === role);
    }

    function getViewMode() {
      // Priority: admin > owner > manager > user
      if (hasRole('admin')) return 'admin';
      if (hasRole('owner')) return 'owner';
      if (hasRole('manager')) return 'manager';
      return 'user';
    }

    function fmtMoney(x) {
      if (x === null || x === undefined) return '-';
      const n = Number(x);
      if (Number.isNaN(n)) return String(x);
      return n.toLocaleString('vi-VN') + ' ₫';
    }
    function fmtDate(s) {
      if (!s) return '-';
      const d = new Date(s);
      if (isNaN(d.getTime())) return s;
      return d.toLocaleString('vi-VN', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    }
    function toIsoOrNullFromDatetimeLocal(v) {
      if (!v) return null;
      // "YYYY-MM-DDTHH:mm" -> keep as-is (backend accepts ISO-ish); optionally add seconds.
      return v;
    }

    // ====== TOAST ======
    function toast(message, type = 'info') {
      const root = document.getElementById('toastRoot');
      const id = 't' + Math.random().toString(16).slice(2);
      const color = { info:'primary', success:'success', warn:'warning', error:'danger' }[type] || 'primary';
      const el = document.createElement('div');
      el.className = `toast align-items-center text-bg-${color} border-0 show mb-2`;
      el.id = id;
      el.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${escapeHtml(message)}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close"></button>
        </div>`;
      el.querySelector('button').onclick = () => el.remove();
      root.appendChild(el);
      setTimeout(() => { el && el.remove(); }, 4500);
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // ====== API CLIENT (response format: {success,message,data}) ======  //{index=13}
    const api = {
      async request(endpoint, options = {}) {
        const base = getBaseUrl();
        const url = base ? `${base}${endpoint}` : endpoint;
        const headers = Object.assign({ 'Content-Type': 'application/json' }, options.headers || {});
        const token = getToken();
        if (token) headers['Authorization'] = `Bearer ${token}`;

        const res = await fetch(url, Object.assign({}, options, { headers }));
        let payload = null;
        try { payload = await res.json(); } catch { payload = null; }

        if (!res.ok) {
          // show 422 errors map if exist
          let msg = (payload && payload.message) ? payload.message : `HTTP ${res.status}`;
          if (payload && payload.errors) {
            msg += ' | ' + JSON.stringify(payload.errors);
          }
          if (res.status === 401) {
            clearAuth();
            window.location.replace('/login');
            return;
          }
          throw new Error(msg);
        }
        return payload;
      },

      // Auth
      async login(email, password) {
        const out = await this.request('/api/auth/login', {
          method: 'POST',
          body: JSON.stringify({ email, password })
        });
        // contract: token + user.roles[] {index=14}
        const token = out?.data?.token;
        const user = out?.data?.user;
        if (!token || !user) throw new Error('Login response missing token/user');
        setToken(token); setUser(user);
        return out;
      },
      async logout() {
        await this.request('/api/auth/logout', { method: 'POST' });
        clearAuth();
      },
      async me() {
        return this.request('/api/auth/me');
      },

      // Public search
      async searchSpaces(params) {
        const qs = new URLSearchParams(params);
        return this.request('/api/search/spaces?' + qs.toString());
      },

      // User
      async myBookings() { return this.request('/api/bookings'); },
      async createBooking(body) {
        return this.request('/api/bookings', { method: 'POST', body: JSON.stringify(body) });
      },
      async cancelBooking(id) { return this.request(`/api/bookings/${id}`, { method: 'DELETE' }); },

      async myPayments() { return this.request('/api/payments'); },
      async pay(body) {
        return this.request('/api/payments', { method: 'POST', body: JSON.stringify(body) });
      },

      // Owner
      async ownerBookings(params) {
        const qs = new URLSearchParams(params);
        return this.request('/api/owner/bookings?' + qs.toString());
      },
      async ownerConfirm(id) { return this.request(`/api/owner/bookings/${id}/confirm`, { method: 'PATCH' }); },
      async ownerReject(id) { return this.request(`/api/owner/bookings/${id}/reject`, { method: 'PATCH' }); },

      async ownerVenues(params) {
        const qs = new URLSearchParams(params || {});
        return this.request('/api/owner/venues?' + qs.toString());
      },
      async createVenue(body) {
        return this.request('/api/owner/venues', { method: 'POST', body: JSON.stringify(body) });
      },
      async updateVenue(id, body) {
        return this.request(`/api/owner/venues/${id}`, { method: 'PUT', body: JSON.stringify(body) });
      },
      async deleteVenue(id) {
        return this.request(`/api/owner/venues/${id}`, { method: 'DELETE' });
      },

      async ownerSpaces(venueId = null) {
        // Get all spaces from all owner's venues, or specific venue
        if (venueId) {
          return this.request(`/api/owner/venues/${venueId}/spaces`);
        }
        return this.request('/api/owner/spaces');
      },
      async createSpace(venueId, body) {
        return this.request(`/api/owner/venues/${venueId}/spaces`, { method: 'POST', body: JSON.stringify(body) });
      },
      async updateSpace(id, body) {
        return this.request(`/api/owner/spaces/${id}`, { method: 'PUT', body: JSON.stringify(body) });
      },
      async deleteSpace(id) {
        return this.request(`/api/owner/spaces/${id}`, { method: 'DELETE' });
      },

      // Admin
      async adminStats(month) {
        const qs = new URLSearchParams();
        if (month) qs.set('month', month);
        return this.request('/api/admin/statistics?' + qs.toString());
      },
      async adminBookings(params) {
        const qs = new URLSearchParams(params);
        return this.request('/api/admin/bookings?' + qs.toString());
      },
      async adminVenues(params) {
        const qs = new URLSearchParams(params);
        return this.request('/api/admin/venues?' + qs.toString());
      },
      async adminApproveVenue(id) { return this.request(`/api/admin/venues/${id}/approve`, { method: 'PATCH' }); },
      async adminRejectVenue(id) { return this.request(`/api/admin/venues/${id}/reject`, { method: 'PATCH' }); },
      async adminBlockVenue(id) { return this.request(`/api/admin/venues/${id}/block`, { method: 'PATCH' }); },
      async adminUnblockVenue(id) { return this.request(`/api/admin/venues/${id}/unblock`, { method: 'PATCH' }); },
      async adminPayments(params) {
        const qs = new URLSearchParams(params);
        return this.request('/api/admin/payments?' + qs.toString());
      },
    };

    // ====== UI HELPERS ======
    function badge(text, kind = 'secondary') {
      return `<span class="badge text-bg-${kind}">${escapeHtml(text)}</span>`;
    }
    function badgeByBookingStatus(st) {
      const kind = BOOKING_STATUS_COLORS[st] || 'secondary';
      return badge(st, kind);
    }
    function badgeByVenueStatus(st) {
      const kind = VENUE_STATUS_COLORS[st] || 'secondary';
      return badge(st, kind);
    }

    function normalizeList(payload) {
      // supports: {data: {data:[...], ...}} OR {data:[...]} OR {data:{items:[...]}}
      const d = payload?.data;
      if (!d) return { items: [], meta: null };
      if (Array.isArray(d)) return { items: d, meta: null };
      if (Array.isArray(d?.data)) return { items: d.data, meta: { current_page:d.current_page, last_page:d.last_page, total:d.total, per_page:d.per_page } };
      if (Array.isArray(d?.items)) return { items: d.items, meta: d.meta || null };
      return { items: [], meta: null };
    }

    function showTab(tabId) {
      ['tabPublic','tabMyBookings','tabMyPayments','tabOwner','tabAdmin'].forEach(id => {
        document.getElementById(id).classList.toggle('d-none', id !== tabId);
      });
      document.querySelectorAll('#mainTabs .nav-link').forEach(a => {
        a.classList.toggle('active', a.dataset.tab === tabId);
      });
    }

    function showAdminTab(tabId) {
      ['adminStats','adminBookings','adminVenues','adminPayments'].forEach(id => {
        document.getElementById(id).classList.toggle('d-none', id !== tabId);
      });
      document.querySelectorAll('#adminTabs .nav-link').forEach(a => {
        a.classList.toggle('active', a.dataset.adminTab === tabId);
      });
    }

    function showOwnerTab(tabId) {
      ['ownerBookings','ownerVenues','ownerSpaces','ownerManagers'].forEach(id => {
        document.getElementById(id).classList.toggle('d-none', id !== tabId);
      });
      document.querySelectorAll('#ownerTabs .nav-link').forEach(a => {
        a.classList.toggle('active', a.dataset.ownerTab === tabId);
      });
    }

    function showManagerTab(tabId) {
      ['managerManagedVenues','managerBookings','managerSpaces'].forEach(id => {
        document.getElementById(id).classList.toggle('d-none', id !== tabId);
      });
      document.querySelectorAll('#managerTabs .nav-link').forEach(a => {
        a.classList.toggle('active', a.dataset.managerTab === tabId);
      });
    }

    function syncAuthUI() {
      const token = getToken();
      const user = getUser();

      // Update user info in header
      const userInfo = document.getElementById('userInfo');
      if (user) {
        const email = user.email || user.full_name || user.name || ('id:'+user.id);
        const roles = (user.roles || []).join(', ') || 'no roles';
        userInfo.textContent = `Logged in as: ${email} | Roles: ${roles}`;
      } else {
        userInfo.textContent = 'Loading...';
      }

      // Tabs visibility based on view mode
      const isAuthed = !!token;
      if (!isAuthed) {
        // Not authenticated - hide all except public
        document.querySelector('[data-tab="tabMyBookings"]').parentElement.classList.add('d-none');
        document.querySelector('[data-tab="tabMyPayments"]').parentElement.classList.add('d-none');
        document.querySelector('[data-tab="tabManager"]').parentElement.classList.add('d-none');
        document.querySelector('[data-tab="tabOwner"]').parentElement.classList.add('d-none');
        document.querySelector('[data-tab="tabAdmin"]').parentElement.classList.add('d-none');
        showTab('tabPublic');
        return;
      }

      const viewMode = getViewMode();

      if (viewMode === 'admin') {
        // Admin: Public + Admin only
        document.querySelector('[data-tab="tabMyBookings"]').parentElement.classList.add('d-none');
        document.querySelector('[data-tab="tabMyPayments"]').parentElement.classList.add('d-none');
        document.querySelector('[data-tab="tabManager"]').parentElement.classList.add('d-none');
        document.querySelector('[data-tab="tabOwner"]').parentElement.classList.add('d-none');
        document.querySelector('[data-tab="tabAdmin"]').parentElement.classList.remove('d-none');
      } else if (viewMode === 'manager') {
        // Manager: Public + Manager only
        document.querySelector('[data-tab="tabMyBookings"]').parentElement.classList.add('d-none');
        document.querySelector('[data-tab="tabMyPayments"]').parentElement.classList.add('d-none');
        document.querySelector('[data-tab="tabManager"]').parentElement.classList.remove('d-none');
        document.querySelector('[data-tab="tabOwner"]').parentElement.classList.add('d-none');
        document.querySelector('[data-tab="tabAdmin"]').parentElement.classList.add('d-none');
      } else if (viewMode === 'owner') {
        // Owner: Public + Owner only
        document.querySelector('[data-tab="tabMyBookings"]').parentElement.classList.add('d-none');
        document.querySelector('[data-tab="tabMyPayments"]').parentElement.classList.add('d-none');
        document.querySelector('[data-tab="tabManager"]').parentElement.classList.add('d-none');
        document.querySelector('[data-tab="tabOwner"]').parentElement.classList.remove('d-none');
        document.querySelector('[data-tab="tabAdmin"]').parentElement.classList.add('d-none');
      } else {
        // User: Public + My Bookings + My Payments
        document.querySelector('[data-tab="tabMyBookings"]').parentElement.classList.remove('d-none');
        document.querySelector('[data-tab="tabMyPayments"]').parentElement.classList.remove('d-none');
        document.querySelector('[data-tab="tabManager"]').parentElement.classList.add('d-none');
        document.querySelector('[data-tab="tabOwner"]').parentElement.classList.add('d-none');
        document.querySelector('[data-tab="tabAdmin"]').parentElement.classList.add('d-none');
      }

      // If current tab hidden -> switch to default based on view mode
      const active = document.querySelector('#mainTabs .nav-link.active');
      if (active && active.parentElement.classList.contains('d-none')) {
        if (viewMode === 'admin') showTab('tabAdmin');
        else if (viewMode === 'manager') showTab('tabManager');
        else if (viewMode === 'owner') showTab('tabOwner');
        else showTab('tabPublic');
      }
    }

    // ====== PUBLIC SEARCH RENDER ======
    function renderSearchRows(items) {
      const tbody = document.getElementById('searchRows');
      tbody.innerHTML = '';
      items.forEach(sp => {
        const venue = sp.venue || {};
        const prices = [
          sp.price_per_hour ? `H: ${fmtMoney(sp.price_per_hour)}` : null,
          sp.price_per_day ? `D: ${fmtMoney(sp.price_per_day)}` : null,
          sp.price_per_month ? `M: ${fmtMoney(sp.price_per_month)}` : null,
        ].filter(Boolean).join('<br>');

        const canBook = !!getToken();
        const btn = canBook
          ? `<button class="btn btn-sm btn-primary" data-action="book" data-space="${sp.id}">Book</button>`
          : `<span class="muted">Login to book</span>`;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><div class="fw-semibold">${escapeHtml(sp.name || ('Space #' + sp.id))}</div><div class="muted">id: <span class="mono">${sp.id}</span></div></td>
          <td>${escapeHtml(venue.name || '-')}</td>
          <td>${escapeHtml(venue.city || '-')}</td>
          <td>${escapeHtml(sp.capacity ?? '-')}</td>
          <td class="mono">${prices || '-'}</td>
          <td class="text-end">${btn}</td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll('button[data-action="book"]').forEach(btn => {
        btn.onclick = () => openBookingModal(btn.dataset.space);
      });
    }

    async function doSearch() {
      try {
        const params = {};
        const q = document.getElementById('q').value.trim();
        const city = document.getElementById('city').value.trim();
        const min_price = document.getElementById('min_price').value.trim();
        const max_price = document.getElementById('max_price').value.trim();
        const per_page = document.getElementById('per_page').value;

        if (q) params.q = q;
        if (city) params.city = city;
        if (min_price) params.min_price = min_price;
        if (max_price) params.max_price = max_price;
        if (per_page) params.per_page = per_page;

        const st = toIsoOrNullFromDatetimeLocal(document.getElementById('start_time').value);
        const en = toIsoOrNullFromDatetimeLocal(document.getElementById('end_time').value);
        if (st && en) { params.start_time = st; params.end_time = en; }

        const out = await api.searchSpaces(params);
        const { items, meta } = normalizeList(out);

        document.getElementById('searchMeta').textContent =
          meta ? `Page ${meta.current_page}/${meta.last_page} · total ${meta.total}` : `Items: ${items.length}`;

        renderSearchRows(items);
        toast('Search loaded', 'success');
      } catch (e) {
        toast(e.message, 'error');
      }
    }

    // ====== BOOKING MODAL ======
    const modalBook = new bootstrap.Modal(document.getElementById('modalBook'));
    function openBookingModal(spaceId) {
      document.getElementById('book_space_id').value = spaceId;
      // prefill from search filter if any
      document.getElementById('book_start').value = document.getElementById('start_time').value || '';
      document.getElementById('book_end').value = document.getElementById('end_time').value || '';
      document.getElementById('book_note').value = '';
      document.getElementById('book_hint').textContent = '';
      modalBook.show();
    }

    document.getElementById('btnBookSubmit').onclick = async () => {
      try {
        const space_id = Number(document.getElementById('book_space_id').value);
        const start_time = toIsoOrNullFromDatetimeLocal(document.getElementById('book_start').value);
        const end_time = toIsoOrNullFromDatetimeLocal(document.getElementById('book_end').value);
        const note = document.getElementById('book_note').value.trim() || null;

        const body = { space_id, start_time, end_time };
        if (note) body.note = note;

        const out = await api.createBooking(body);
        toast(out?.message || 'Booking created', 'success');
        modalBook.hide();

        if (!document.getElementById('tabMyBookings').classList.contains('d-none')) {
          await loadMyBookings();
        }
      } catch (e) {
        document.getElementById('book_hint').textContent = e.message;
        toast(e.message, 'error');
      }
    };

    // ====== MY BOOKINGS ======
    function canCancelBooking(status) {
      // cancel allowed before payment success; UI-side quick gating
      return ['pending_confirmation','awaiting_payment','confirmed'].includes(status);
    }
    function canPayBooking(status) {
      return ['awaiting_payment','confirmed'].includes(status);
    }

    function renderMyBookings(items) {
      const tbody = document.getElementById('myBookingRows');
      tbody.innerHTML = '';
      items.forEach(b => {
        const st = b.status;
        const spaceName = b.space?.name || b.space_name || ('Space #' + (b.space_id ?? '-'));
        const venueName = b.venue?.name || b.space?.venue?.name || b.venue_name || '-';
        const venueAddr = b.venue?.address || b.space?.venue?.address || '';

        const actions = [];
        if (canPayBooking(st)) actions.push(`<button class="btn btn-sm btn-primary" data-act="pay" data-id="${b.id}">Pay</button>`);
        if (canCancelBooking(st)) actions.push(`<button class="btn btn-sm btn-outline-warning" data-act="cancel" data-id="${b.id}">Cancel</button>`);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${b.id}</td>
          <td>${badgeByBookingStatus(st)}</td>
          <td>${fmtDate(b.start_time)} → ${fmtDate(b.end_time)}</td>
          <td class="mono">${fmtMoney(b.total_price)}</td>
          <td>
            <div class="fw-semibold">${escapeHtml(spaceName)}</div>
            <div class="muted">${escapeHtml(venueName)} ${venueAddr ? ('· ' + escapeHtml(venueAddr)) : ''}</div>
          </td>
          <td class="text-end d-flex gap-2 justify-content-end">${actions.join('') || '<span class="muted">-</span>'}</td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll('button[data-act="cancel"]').forEach(btn => {
        btn.onclick = async () => {
          if (!confirm('Cancel this booking?')) return;
          try {
            const out = await api.cancelBooking(btn.dataset.id);
            toast(out?.message || 'Cancelled', 'success');
            await loadMyBookings();
          } catch (e) {
            toast(e.message, 'error');
          }
        };
      });
      tbody.querySelectorAll('button[data-act="pay"]').forEach(btn => {
        btn.onclick = () => openPayModal(btn.dataset.id);
      });
    }

    async function loadMyBookings() {
      try {
        const out = await api.myBookings();
        const { items } = normalizeList(out);
        renderMyBookings(items);
        toast('My bookings loaded', 'success');
      } catch (e) {
        toast(e.message, 'error');
      }
    }

    // ====== PAY MODAL ======
    const modalPay = new bootstrap.Modal(document.getElementById('modalPay'));
    function openPayModal(bookingId) {
      document.getElementById('pay_booking_id').value = bookingId;
      document.getElementById('pay_method').value = 'bank_transfer';
      modalPay.show();
    }

    document.getElementById('btnPaySubmit').onclick = async () => {
      try {
        const booking_id = Number(document.getElementById('pay_booking_id').value);
        const payment_method = document.getElementById('pay_method').value;
        const out = await api.pay({ booking_id, payment_method });
        toast(out?.message || 'Payment created', 'success');
        modalPay.hide();
        await loadMyBookings();
        await loadMyPayments();
      } catch (e) {
        toast(e.message, 'error');
      }
    };

    // ====== MY PAYMENTS ======
    function renderMyPayments(items) {
      const tbody = document.getElementById('myPaymentRows');
      tbody.innerHTML = '';
      items.forEach(p => {
        const st = p.transaction_status || p.status || '-';
        const method = p.payment_method || p.method || '-';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${p.id ?? '-'}</td>
          <td class="mono">${p.booking_id ?? p.booking?.id ?? '-'}</td>
          <td class="mono">${fmtMoney(p.amount)}</td>
          <td class="mono">${escapeHtml(method)}</td>
          <td>${badge(st, st === 'success' ? 'success' : (st === 'failed' ? 'danger' : 'warning'))}</td>
          <td>${fmtDate(p.paid_at)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function loadMyPayments() {
      try {
        const out = await api.myPayments();
        const { items } = normalizeList(out);
        renderMyPayments(items);
        toast('My payments loaded', 'success');
      } catch (e) {
        toast(e.message, 'error');
      }
    }

    // ====== OWNER STATE ======
    const ownerState = {
      venues: [],
      spaces: [],
      selectedVenueId: null,
    };

    // ====== OWNER VENUES ======
    function renderOwnerVenues(items) {
      const tbody = document.getElementById('ownerVenueRows');
      tbody.innerHTML = '';

      if (items.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6" class="text-center muted">No venues found. Create your first venue!</td>';
        tbody.appendChild(tr);
        return;
      }

      items.forEach(v => {
        const tr = document.createElement('tr');
        const spacesCount = v.spaces_count ?? v.spaces?.length ?? 0;
        tr.innerHTML = `
          <td class="mono">${v.id}</td>
          <td>
            <div class="fw-semibold">${escapeHtml(v.name || '-')}</div>
            <div class="muted">${escapeHtml(v.address || '')}</div>
          </td>
          <td>${escapeHtml(v.city || '-')}</td>
          <td>${badgeByVenueStatus(v.status)}</td>
          <td class="mono">${spacesCount}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-light" data-act="view-spaces" data-id="${v.id}" data-venue='${JSON.stringify(v).replace(/'/g, "&apos;")}'>View Spaces</button>
            <button class="btn btn-sm btn-outline-info" data-act="manage-managers" data-id="${v.id}" data-name="${escapeHtml(v.name)}" title="Manage managers for this venue">👥</button>
            <button class="btn btn-sm btn-outline-primary" data-act="edit-venue" data-id="${v.id}" data-venue='${JSON.stringify(v).replace(/'/g, "&apos;")}'>Edit</button>
            <button class="btn btn-sm btn-outline-danger" data-act="delete-venue" data-id="${v.id}" data-name="${escapeHtml(v.name)}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function loadOwnerVenues() {
      try {
        const out = await api.ownerVenues();
        const { items } = normalizeList(out);
        ownerState.venues = items;
        renderOwnerVenues(items);
        toast('Venues loaded successfully', 'success');
      } catch (e) {
        document.getElementById('ownerVenueRows').innerHTML =
          `<tr><td colspan="6" class="text-center text-danger">Error: ${escapeHtml(e.message)}</td></tr>`;
        toast(e.message, 'error');
      }
    }

    async function deleteOwnerVenue(id) {
      if (!confirm('Are you sure you want to delete this venue? All spaces and bookings will be affected.')) return;

      try {
        await api.deleteVenue(id);
        toast('Venue deleted successfully', 'success');
        await loadOwnerVenues(); // Reload list
      } catch (e) {
        toast(`Failed to delete venue: ${e.message}`, 'error');
      }
    }

    // ====== OWNER SPACES ======
    function renderOwnerSpaces(items) {
      const tbody = document.getElementById('ownerSpaceRows');
      tbody.innerHTML = '';

      if (items.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="7" class="text-center muted">No spaces found. Add spaces to your venues first!</td>';
        tbody.appendChild(tr);
        return;
      }

      items.forEach(s => {
        const venue = s.venue || {};
        const spaceType = s.space_type || {};
        const prices = [
          s.price_per_hour ? `H: ${fmtMoney(s.price_per_hour)}` : null,
          s.price_per_day ? `D: ${fmtMoney(s.price_per_day)}` : null,
          s.price_per_month ? `M: ${fmtMoney(s.price_per_month)}` : null,
        ].filter(Boolean).join('<br>') || '-';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${s.id}</td>
          <td>
            <div class="fw-semibold">${escapeHtml(s.name || '-')}</div>
            <div class="muted">${escapeHtml(spaceType.type_name || '')}</div>
          </td>
          <td>${escapeHtml(venue.name || '-')}</td>
          <td class="mono">${s.capacity ?? '-'}</td>
          <td class="mono" style="font-size:11px">${prices}</td>
          <td class="mono" style="font-size:11px">${s.open_hour || '-'} - ${s.close_hour || '-'}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-info" data-act="view-amenities" data-id="${s.id}" title="View amenities">🏷️</button>
            <button class="btn btn-sm btn-outline-primary" data-act="edit-space" data-id="${s.id}" data-space='${JSON.stringify(s).replace(/'/g, "&apos;")}'>Edit</button>
            <button class="btn btn-sm btn-outline-danger" data-act="delete-space" data-id="${s.id}" data-name="${escapeHtml(s.name)}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function loadOwnerSpaces() {
      try {
        const out = await api.ownerSpaces();
        const { items } = normalizeList(out);
        ownerState.spaces = items;
        renderOwnerSpaces(items);
        toast('Spaces loaded successfully', 'success');
      } catch (e) {
        document.getElementById('ownerSpaceRows').innerHTML =
          `<tr><td colspan="7" class="text-center text-danger">Error: ${escapeHtml(e.message)}</td></tr>`;
        toast(e.message, 'error');
      }
    }

    async function deleteOwnerSpace(id) {
      if (!confirm('Are you sure you want to delete this space? All bookings will be affected.')) return;

      try {
        await api.deleteSpace(id);
        toast('Space deleted successfully', 'success');
        await loadOwnerSpaces(); // Reload spaces
        await loadOwnerVenues(); // Reload venues to update spaces_count
      } catch (e) {
        toast(`Failed to delete space: ${e.message}`, 'error');
      }
    }

    // ====== OWNER MANAGERS ======
    function renderOwnerManagers(items) {
      const tbody = document.getElementById('ownerManagerRows');
      tbody.innerHTML = '';

      if (items.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="5" class="text-center muted">No managers assigned to this venue</td>';
        tbody.appendChild(tr);
        return;
      }

      items.forEach(m => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${m.id}</td>
          <td>${escapeHtml(m.full_name || m.name || '-')}</td>
          <td>${escapeHtml(m.email || '-')}</td>
          <td>${escapeHtml(m.phone_number || m.phone || '-')}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-danger" data-act="delete-manager" data-id="${m.id}" data-email="${escapeHtml(m.email)}">Remove</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function loadOwnerManagers(venueId) {
      if (!venueId) {
        document.getElementById('ownerManagerRows').innerHTML =
          '<tr><td colspan="5" class="text-center muted">Please select a venue first</td></tr>';
        document.getElementById('inputManagerEmail').disabled = true;
        document.getElementById('btnAddManager').disabled = true;
        document.getElementById('managersVenueTitle').textContent = 'Select a venue first';
        return;
      }

      try {
        const out = await api.request(`/api/owner/venues/${venueId}/managers`);
        const managers = out?.data || [];
        renderOwnerManagers(managers);

        // Enable inputs
        document.getElementById('inputManagerEmail').disabled = false;
        document.getElementById('btnAddManager').disabled = false;

        // Update title
        const venue = ownerState.venues.find(v => v.id === venueId);
        document.getElementById('managersVenueTitle').textContent = `Managers of: ${venue?.name || 'Venue #'+venueId}`;

        toast('Managers loaded', 'success');
      } catch (e) {
        document.getElementById('ownerManagerRows').innerHTML =
          `<tr><td colspan="5" class="text-center text-danger">Error: ${escapeHtml(e.message)}</td></tr>`;
        toast(e.message, 'error');
      }
    }

    async function addOwnerManager(venueId, email) {
      if (!venueId || !email) {
        toast('Venue and email are required', 'error');
        return;
      }

      try {
        await api.request(`/api/owner/venues/${venueId}/managers`, {
          method: 'POST',
          body: JSON.stringify({ email })
        });
        toast('Manager added successfully', 'success');
        await loadOwnerManagers(venueId);
        document.getElementById('inputManagerEmail').value = '';
      } catch (e) {
        toast(`Failed to add manager: ${e.message}`, 'error');
      }
    }

    async function deleteOwnerManager(venueId, userId, email) {
      if (!confirm(`Remove manager ${email}?`)) return;

      try {
        await api.request(`/api/owner/venues/${venueId}/managers/${userId}`, {
          method: 'DELETE'
        });
        toast('Manager removed successfully', 'success');
        await loadOwnerManagers(venueId);
      } catch (e) {
        toast(`Failed to remove manager: ${e.message}`, 'error');
      }
    }

    // ====== OWNER BOOKINGS ======
    function renderOwnerBookings(items) {
      const tbody = document.getElementById('ownerBookingRows');
      tbody.innerHTML = '';
      items.forEach(b => {
        const st = b.status;
        const user = b.user || {};
        const space = b.space || {};
        const venue = b.venue || space.venue || {};

        const actions = [];
        if (st === 'pending_confirmation') {
          actions.push(`<button class="btn btn-sm btn-primary" data-act="confirm" data-id="${b.id}">Confirm</button>`);
          actions.push(`<button class="btn btn-sm btn-outline-danger" data-act="reject" data-id="${b.id}">Reject</button>`);
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${b.id}</td>
          <td>${badgeByBookingStatus(st)}</td>
          <td>
            <div class="fw-semibold">${escapeHtml(user.name || user.full_name || '-')}</div>
            <div class="muted mono">${escapeHtml(user.email || '-')}</div>
          </td>
          <td>${fmtDate(b.start_time)} → ${fmtDate(b.end_time)}</td>
          <td>
            <div class="fw-semibold">${escapeHtml(space.name || ('Space #' + (b.space_id ?? '-')))}</div>
            <div class="muted">${escapeHtml(venue.name || '-')}</div>
          </td>
          <td class="mono">${fmtMoney(b.total_price)}</td>
          <td class="text-end d-flex gap-2 justify-content-end">${actions.join('') || '<span class="muted">-</span>'}</td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll('button[data-act="confirm"]').forEach(btn => {
        btn.onclick = async () => {
          try {
            const out = await api.ownerConfirm(btn.dataset.id);
            toast(out?.message || 'Confirmed', 'success');
            await loadOwnerBookings();
          } catch (e) { toast(e.message, 'error'); }
        };
      });
      tbody.querySelectorAll('button[data-act="reject"]').forEach(btn => {
        btn.onclick = async () => {
          if (!confirm('Reject this booking?')) return;
          try {
            const out = await api.ownerReject(btn.dataset.id);
            toast(out?.message || 'Rejected', 'success');
            await loadOwnerBookings();
          } catch (e) { toast(e.message, 'error'); }
        };
      });
    }

    async function loadOwnerBookings(extraParams = {}) {
      try {
        const params = Object.assign({}, extraParams);
        const st = document.getElementById('owner_status').value.trim();
        const venue_id = document.getElementById('owner_venue_id').value.trim();
        const space_id = document.getElementById('owner_space_id').value.trim();
        const start_date = document.getElementById('owner_start_date').value;
        const end_date = document.getElementById('owner_end_date').value;

        if (st) params.status = st;
        if (venue_id) params.venue_id = venue_id;
        if (space_id) params.space_id = space_id;
        if (start_date) params.start_date = start_date;
        if (end_date) params.end_date = end_date;

        const out = await api.ownerBookings(params);
        const { items } = normalizeList(out);
        renderOwnerBookings(items);
        toast('Owner bookings loaded', 'success');
      } catch (e) {
        toast(e.message, 'error');
      }
    }

    // ====== MANAGER ======
    async function loadManagerVenues() {
      try {
        const out = await api.request('/api/owner/venues');
        const venues = out?.data || [];

        const tbody = document.getElementById('managerVenueRows');
        tbody.innerHTML = '';

        if (venues.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No managed venues</td></tr>';
          return;
        }

        venues.forEach(venue => {
          const statusBadge = {
            'approved': '<span class="badge bg-success">Approved</span>',
            'pending': '<span class="badge bg-warning">Pending</span>',
            'blocked': '<span class="badge bg-danger">Blocked</span>',
            'rejected': '<span class="badge bg-secondary">Rejected</span>',
          }[venue.status] || venue.status;

          tbody.innerHTML += `
            <tr>
              <td><span class="mono">${venue.id}</span></td>
              <td>${escapeHtml(venue.name)}</td>
              <td>${escapeHtml(venue.city || '-')}</td>
              <td>${statusBadge}</td>
              <td><span class="badge badge-soft">${venue.spaces_count || 0} spaces</span></td>
            </tr>
          `;
        });
      } catch (e) {
        toast(e.message, 'error');
        document.getElementById('managerVenueRows').innerHTML =
          `<tr><td colspan="5" class="text-center text-danger">Error: ${escapeHtml(e.message)}</td></tr>`;
      }
    }

    async function loadManagerSpaces() {
      try {
        const out = await api.request('/api/owner/spaces');
        const spaces = out?.data || [];

        const tbody = document.getElementById('managerSpaceRows');
        tbody.innerHTML = '';

        if (spaces.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center muted">No managed spaces</td></tr>';
          return;
        }

        spaces.forEach(sp => {
          const venue = sp.venue || {};
          const prices = [
            sp.price_per_hour ? `H: ${fmtMoney(sp.price_per_hour)}` : null,
            sp.price_per_day ? `D: ${fmtMoney(sp.price_per_day)}` : null,
            sp.price_per_month ? `M: ${fmtMoney(sp.price_per_month)}` : null,
          ].filter(Boolean).join(' / ');
          const time = sp.open_hour && sp.close_hour ? `${sp.open_hour} - ${sp.close_hour}` : '-';
          const amenities = (sp.amenities || []).map(a => a.amenity_name || a.name).join(', ');

          tbody.innerHTML += `
            <tr>
              <td><span class="mono">${sp.id}</span></td>
              <td><strong>${escapeHtml(sp.name)}</strong><br><small class="muted">${sp.space_type?.name || '-'}</small></td>
              <td>${escapeHtml(venue.name || '-')}</td>
              <td><span class="badge badge-soft">${sp.capacity || '-'}</span></td>
              <td>${prices || '-'}</td>
              <td><small>${time}</small></td>
            </tr>
          `;
        });
      } catch (e) {
        toast(e.message, 'error');
        document.getElementById('managerSpaceRows').innerHTML =
          `<tr><td colspan="6" class="text-center text-danger">Error: ${escapeHtml(e.message)}</td></tr>`;
      }
    }

    async function loadManagerBookings() {
      try {
        const status = 'pending_confirmation';
        const out = await api.request(`/api/owner/bookings?status=${status}`);
        const bookings = out?.data?.data || out?.data || [];

        const tbody = document.getElementById('managerBookingRows');
        tbody.innerHTML = '';

        if (bookings.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center muted">No pending bookings</td></tr>';
          return;
        }

        bookings.forEach(b => {
          const space = b.space || {};
          const venue = space.venue || {};
          const user = b.user || {};
          const time = `${fmtDate(b.start_time)}<br>→ ${fmtDate(b.end_time)}`;
          const total = fmtMoney(b.total_price);

          tbody.innerHTML += `
            <tr>
              <td><span class="mono">#${b.id}</span></td>
              <td><span class="badge bg-warning">${b.status}</span></td>
              <td>${escapeHtml(user.full_name || '-')}<br><small>${escapeHtml(user.email || '-')}</small></td>
              <td><small>${time}</small></td>
              <td>${escapeHtml(space.name || '-')}<br><small>${escapeHtml(venue.name || '-')}</small></td>
              <td>${total}</td>
            </tr>
          `;
        });
      } catch (e) {
        toast(e.message, 'error');
        document.getElementById('managerBookingRows').innerHTML =
          `<tr><td colspan="6" class="text-center text-danger">Error: ${escapeHtml(e.message)}</td></tr>`;
      }
    }

    // ====== ADMIN ======
    function drawBarChart(canvasId, obj) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const entries = Object.entries(obj || {});
      if (!entries.length) {
        ctx.fillText('No data', 10, 20);
        return;
      }

      const padding = 20;
      const w = canvas.width - padding*2;
      const h = canvas.height - padding*2;
      const max = Math.max(...entries.map(([,v]) => Number(v) || 0), 1);

      // axes
      ctx.strokeStyle = 'rgba(255,255,255,0.25)';
      ctx.beginPath();
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, padding + h);
      ctx.lineTo(padding + w, padding + h);
      ctx.stroke();

      const barW = w / entries.length * 0.72;
      const gap = w / entries.length * 0.28;

      ctx.fillStyle = 'rgba(76,111,255,0.75)';
      ctx.font = '12px ui-monospace, monospace';

      entries.forEach(([k,v], i) => {
        const val = Number(v) || 0;
        const bh = (val / max) * (h - 10);
        const x = padding + i * (barW + gap) + gap/2;
        const y = padding + h - bh;

        ctx.fillRect(x, y, barW, bh);

        ctx.fillStyle = 'rgba(232,236,255,0.85)';
        ctx.fillText(String(val), x, y - 6);
        ctx.save();
        ctx.translate(x, padding + h + 14);
        ctx.rotate(-0.35);
        ctx.fillText(k, 0, 0);
        ctx.restore();

        ctx.fillStyle = 'rgba(76,111,255,0.75)';
      });
    }

    async function loadAdminStats() {
      const month = document.getElementById('admin_month').value || '';
      const out = await api.adminStats(month);
      const d = out?.data || {};

      document.getElementById('st_total_users').textContent = d.total_users ?? '-';
      document.getElementById('st_new_users').textContent = d.new_users_in_month ?? '-';
      document.getElementById('st_bookings_month').textContent = d.bookings_in_month ?? '-';
      document.getElementById('st_rev_month').textContent = fmtMoney(d.revenue_in_month ?? null);
      document.getElementById('st_total_venues').textContent = d.total_venues ?? '-';
      document.getElementById('st_pending_venues').textContent = d.pending_venues ?? '-';
      document.getElementById('st_approved_venues').textContent = d.approved_venues ?? '-';
      document.getElementById('st_total_revenue').textContent = fmtMoney(d.total_revenue ?? null);
      document.getElementById('st_month').textContent = d.month ?? (month || '-');

      drawBarChart('chartStatus', d.bookings_by_status_in_month || {});
    }

    function renderAdminBookings(items, meta) {
      const tbody = document.getElementById('ab_rows');
      tbody.innerHTML = '';
      items.forEach(b => {
        const user = b.user || {};
        const space = b.space || {};
        const venue = b.venue || {};
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${b.id}</td>
          <td>${badgeByBookingStatus(b.status)}</td>
          <td>${escapeHtml(user.name || '-') }<div class="muted mono">${escapeHtml(user.email || '')}</div></td>
          <td>${fmtDate(b.start_time)} → ${fmtDate(b.end_time)}</td>
          <td>${escapeHtml(space.name || '-') }<div class="muted">${escapeHtml(venue.name || '')}</div></td>
          <td class="mono">${fmtMoney(b.total_price)}</td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById('ab_meta').textContent = meta ? `Page ${meta.current_page}/${meta.last_page} · total ${meta.total}` : `Items ${items.length}`;
    }

    async function loadAdminBookings() {
      const params = {};
      const status = document.getElementById('ab_status').value.trim();
      const start_date = document.getElementById('ab_start_date').value;
      const end_date = document.getElementById('ab_end_date').value;
      const user_id = document.getElementById('ab_user_id').value.trim();
      const venue_id = document.getElementById('ab_venue_id').value.trim();
      const search = document.getElementById('ab_search').value.trim();

      if (status) params.status = status;
      if (start_date) params.start_date = start_date;
      if (end_date) params.end_date = end_date;
      if (user_id) params.user_id = user_id;
      if (venue_id) params.venue_id = venue_id;
      if (search) params.search = search;

      const out = await api.adminBookings(params);
      const { items, meta } = normalizeList(out);
      renderAdminBookings(items, meta);
    }

    function renderAdminVenues(items, meta) {
      const tbody = document.getElementById('av_rows');
      tbody.innerHTML = '';
      items.forEach(v => {
        const st = v.status;
        const actions = [];

        if (st === 'pending') {
          actions.push(`<button class="btn btn-sm btn-primary" data-act="approve" data-id="${v.id}">Approve</button>`);
          actions.push(`<button class="btn btn-sm btn-outline-danger" data-act="reject" data-id="${v.id}">Reject</button>`);
        } else if (st === 'approved') {
          actions.push(`<button class="btn btn-sm btn-outline-warning" data-act="block" data-id="${v.id}">Block</button>`);
        } else if (st === 'blocked') {
          actions.push(`<button class="btn btn-sm btn-outline-light" data-act="unblock" data-id="${v.id}">Unblock</button>`);
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${v.id}</td>
          <td>${escapeHtml(v.name || '-')}</td>
          <td>${escapeHtml(v.city || '-')}</td>
          <td>${badgeByVenueStatus(st)}</td>
          <td>${fmtDate(v.created_at)}</td>
          <td class="text-end d-flex gap-2 justify-content-end">${actions.join('') || '<span class="muted">-</span>'}</td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById('av_meta').textContent = meta ? `Page ${meta.current_page}/${meta.last_page} · total ${meta.total}` : `Items ${items.length}`;

      tbody.querySelectorAll('button').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.dataset.id;
          try {
            if (btn.dataset.act === 'approve') await api.adminApproveVenue(id);
            if (btn.dataset.act === 'reject')  await api.adminRejectVenue(id);
            if (btn.dataset.act === 'block')   await api.adminBlockVenue(id);
            if (btn.dataset.act === 'unblock') await api.adminUnblockVenue(id);
            toast('Venue updated', 'success');
            await loadAdminVenues();
          } catch (e) { toast(e.message, 'error'); }
        };
      });
    }

    async function loadAdminVenues() {
      const params = {};
      const st = document.getElementById('av_status').value;
      if (st) params.status = st;
      const out = await api.adminVenues(params);
      const { items, meta } = normalizeList(out);
      renderAdminVenues(items, meta);
    }

    function renderAdminPayments(items, meta) {
      const tbody = document.getElementById('ap_rows');
      tbody.innerHTML = '';
      items.forEach(p => {
        const st = p.transaction_status || p.status || '-';
        const method = p.payment_method || p.method || '-';
        const user = p.booking?.user || p.user || {};
        const venue = p.booking?.space?.venue || p.venue || {};

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${p.id ?? '-'}</td>
          <td class="mono">${p.booking_id ?? p.booking?.id ?? '-'}</td>
          <td class="mono">${fmtMoney(p.amount)}</td>
          <td class="mono">${escapeHtml(method)}</td>
          <td>${badge(st, st === 'success' ? 'success' : (st === 'failed' ? 'danger' : 'warning'))}</td>
          <td>${fmtDate(p.paid_at)}</td>
          <td>${escapeHtml(user.name || user.full_name || '-')}</td>
          <td>${escapeHtml(venue.name || '-')}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function loadAdminPayments() {
      const params = {};
      const status = document.getElementById('ap_status').value.trim();
      const payment_method = document.getElementById('ap_method').value.trim();
      const user_id = document.getElementById('ap_user_id').value.trim();
      const venue_id = document.getElementById('ap_venue_id').value.trim();
      const space_id = document.getElementById('ap_space_id').value.trim();
      const month = document.getElementById('admin_month').value || '';

      if (status) params.status = status;
      if (payment_method) params.payment_method = payment_method;
      if (user_id) params.user_id = user_id;
      if (venue_id) params.venue_id = venue_id;
      if (space_id) params.space_id = space_id;
      if (month) params.month = month;

      const out = await api.adminPayments(params);
      const { items, meta } = normalizeList(out);
      renderAdminPayments(items, meta);
    }

    // ====== EVENTS / WIRING ======

    document.getElementById('btnLogout')?.addEventListener('click', async () => {
      try {
        await api.logout();
      } catch (err) {
        // Ignore errors, always clear auth
      }
      clearAuth();
      window.location.href = '/login';
    });

    document.getElementById('btnProfile')?.addEventListener('click', () => {
      window.location.href = '/profile';
    });

    document.getElementById('btnMe')?.addEventListener('click', async () => {
      try {
        const out = await api.me();
        const u = out?.data?.user;
        if (u) setUser(u);
        toast('Me loaded', 'success');
        syncAuthUI();
      } catch (e) { toast(e.message, 'error'); }
    });

    document.getElementById('btnSearch')?.addEventListener('click', doSearch);

    document.getElementById('btnLoadMyBookings')?.addEventListener('click', loadMyBookings);
    document.getElementById('btnLoadMyPayments')?.addEventListener('click', loadMyPayments);

    document.getElementById('btnLoadOwnerBookings')?.addEventListener('click', () => loadOwnerBookings());
    document.getElementById('btnOwnerFilter')?.addEventListener('click', () => loadOwnerBookings());

    document.getElementById('btnAdminRefresh')?.addEventListener('click', async () => {
      try {
        await loadAdminStats();
        if (!document.getElementById('adminBookings')?.classList.contains('d-none')) await loadAdminBookings();
        if (!document.getElementById('adminVenues')?.classList.contains('d-none')) await loadAdminVenues();
        if (!document.getElementById('adminPayments')?.classList.contains('d-none')) await loadAdminPayments();
        toast('Admin refreshed', 'success');
      } catch (e) { toast(e.message, 'error'); }
    });

    document.getElementById('btnAdminBookings')?.addEventListener('click', async () => {
      try { await loadAdminBookings(); toast('Admin bookings loaded', 'success'); } catch(e){ toast(e.message,'error'); }
    });
    document.getElementById('btnAdminVenues')?.addEventListener('click', async () => {
      try { await loadAdminVenues(); toast('Admin venues loaded', 'success'); } catch(e){ toast(e.message,'error'); }
    });
    document.getElementById('btnAdminPayments')?.addEventListener('click', async () => {
      try { await loadAdminPayments(); toast('Admin payments loaded', 'success'); } catch(e){ toast(e.message,'error'); }
    });

    // Manager buttons
    document.getElementById('btnLoadManagerVenues')?.addEventListener('click', () => loadManagerVenues());
    document.getElementById('btnLoadManagerBookings')?.addEventListener('click', () => loadManagerBookings());
    document.getElementById('btnLoadManagerSpaces')?.addEventListener('click', () => loadManagerSpaces());

    // Main tabs
    document.querySelectorAll('#mainTabs .nav-link').forEach(a => {
      a.onclick = async (e) => {
        e.preventDefault();
        const tab = a.dataset.tab;
        showTab(tab);
        // lazy load
        try {
          if (tab === 'tabPublic') await doSearch();
          if (tab === 'tabMyBookings') await loadMyBookings();
          if (tab === 'tabMyPayments') await loadMyPayments();
          if (tab === 'tabOwner') await loadOwnerBookings();
          if (tab === 'tabManager') await loadManagerVenues();
          if (tab === 'tabAdmin') {
            await loadAdminStats();
            // default admin subtab stays stats
          }
        } catch (err) {
          toast(err.message, 'error');
        }
      };
    });

    // Admin subtabs
    document.querySelectorAll('#adminTabs .nav-link').forEach(a => {
      a.onclick = async (e) => {
        e.preventDefault();
        const tab = a.dataset.adminTab;
        showAdminTab(tab);
        try {
          if (tab === 'adminStats') await loadAdminStats();
          if (tab === 'adminBookings') await loadAdminBookings();
          if (tab === 'adminVenues') await loadAdminVenues();
          if (tab === 'adminPayments') await loadAdminPayments();
        } catch (err) { toast(err.message, 'error'); }
      };
    });

    // Owner sub-tabs
    document.querySelectorAll('#ownerTabs .nav-link').forEach(a => {
      a.onclick = async (e) => {
        e.preventDefault();
        const tab = a.dataset.ownerTab;
        showOwnerTab(tab);
        try {
          if (tab === 'ownerBookings') await loadOwnerBookings();
          else if (tab === 'ownerVenues') await loadOwnerVenues();
          else if (tab === 'ownerSpaces') await loadOwnerSpaces();
          else if (tab === 'ownerManagers') {
            // Load managers for selected venue (or show prompt to select)
            if (ownerState.selectedVenueId) {
              await loadOwnerManagers(ownerState.selectedVenueId);
            } else {
              document.getElementById('ownerManagerRows').innerHTML =
                '<tr><td colspan="5" class="text-center muted">Please select a venue from "My Venues" tab first (click View Spaces)</td></tr>';
            }
          }
        } catch (err) { toast(err.message, 'error'); }
      };
    });

    // Manager sub-tabs
    document.querySelectorAll('#managerTabs .nav-link').forEach(a => {
      a.onclick = async (e) => {
        e.preventDefault();
        const tab = a.dataset.managerTab;
        showManagerTab(tab);
        try {
          if (tab === 'managerManagedVenues') {
            await loadManagerVenues();
          } else if (tab === 'managerBookings') {
            await loadManagerBookings();
          } else if (tab === 'managerSpaces') {
            await loadManagerSpaces();
          }
        } catch (err) { toast(err.message, 'error'); }
      };
    });

    // ====== OWNER MODALS & EVENT HANDLERS ======

    // Add Venue Modal
    function openAddVenueModal() {
      const html = `
        <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.5)" id="modalAddVenue">
          <div class="modal-dialog">
            <div class="modal-content" style="background:#0d1b2a;border:1px solid #1e3a5f">
              <div class="modal-header">
                <h5 class="modal-title">Add New Venue</h5>
                <button type="button" class="btn-close btn-close-white" onclick="document.getElementById('modalAddVenue').remove()"></button>
              </div>
              <div class="modal-body">
                <div class="mb-2">
                  <label class="form-label">Name *</label>
                  <input type="text" class="form-control" id="venName" required>
                  <small class="text-danger d-none" id="errVenName"></small>
                </div>
                <div class="mb-2">
                  <label class="form-label">Address *</label>
                  <input type="text" class="form-control" id="venAddress" required>
                  <small class="text-danger d-none" id="errVenAddress"></small>
                </div>
                <div class="mb-2">
                  <label class="form-label">City *</label>
                  <input type="text" class="form-control" id="venCity" required>
                  <small class="text-danger d-none" id="errVenCity"></small>
                </div>
                <div class="mb-2">
                  <label class="form-label">Street</label>
                  <input type="text" class="form-control" id="venStreet">
                </div>
                <div class="row">
                  <div class="col-6 mb-2">
                    <label class="form-label">Latitude</label>
                    <input type="number" step="any" class="form-control" id="venLat">
                    <small class="text-danger d-none" id="errVenLat"></small>
                  </div>
                  <div class="col-6 mb-2">
                    <label class="form-label">Longitude</label>
                    <input type="number" step="any" class="form-control" id="venLng">
                    <small class="text-danger d-none" id="errVenLng"></small>
                  </div>
                </div>
                <div class="mb-2">
                  <label class="form-label">Description</label>
                  <textarea class="form-control" id="venDesc" rows="3"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('modalAddVenue').remove()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAddVenue()">Create Venue</button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
      document.getElementById('venName').focus();
    }

    async function submitAddVenue() {
      const data = {
        name: document.getElementById('venName').value.trim(),
        address: document.getElementById('venAddress').value.trim(),
        city: document.getElementById('venCity').value.trim(),
        street: document.getElementById('venStreet').value.trim() || null,
        latitude: document.getElementById('venLat').value || null,
        longitude: document.getElementById('venLng').value || null,
        description: document.getElementById('venDesc').value.trim() || null,
      };

      // Clear previous errors
      ['Name','Address','City','Lat','Lng'].forEach(field => {
        const el = document.getElementById('errVen'+field);
        if (el) el.classList.add('d-none');
      });

      try {
        await api.createVenue(data);
        document.getElementById('modalAddVenue').remove();
        toast('Venue created! Pending admin approval.', 'success');
        await loadOwnerVenues();
      } catch (e) {
        if (e.status === 422 && e.data?.errors) {
          const errs = e.data.errors;
          if (errs.name) document.getElementById('errVenName').textContent = errs.name[0], document.getElementById('errVenName').classList.remove('d-none');
          if (errs.address) document.getElementById('errVenAddress').textContent = errs.address[0], document.getElementById('errVenAddress').classList.remove('d-none');
          if (errs.city) document.getElementById('errVenCity').textContent = errs.city[0], document.getElementById('errVenCity').classList.remove('d-none');
          if (errs.latitude) document.getElementById('errVenLat').textContent = errs.latitude[0], document.getElementById('errVenLat').classList.remove('d-none');
          if (errs.longitude) document.getElementById('errVenLng').textContent = errs.longitude[0], document.getElementById('errVenLng').classList.remove('d-none');
        }
        toast(e.message, 'error');
      }
    }

    // Edit Venue Modal
    function openEditVenueModal(venue) {
      const v = typeof venue === 'string' ? JSON.parse(venue) : venue;
      const html = `
        <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.5)" id="modalEditVenue">
          <div class="modal-dialog">
            <div class="modal-content" style="background:#0d1b2a;border:1px solid #1e3a5f">
              <div class="modal-header">
                <h5 class="modal-title">Edit Venue</h5>
                <button type="button" class="btn-close btn-close-white" onclick="document.getElementById('modalEditVenue').remove()"></button>
              </div>
              <div class="modal-body">
                <div class="mb-2">
                  <label class="form-label">Name *</label>
                  <input type="text" class="form-control" id="editVenName" value="${escapeHtml(v.name||'')}">
                  <small class="text-danger d-none" id="errEditVenName"></small>
                </div>
                <div class="mb-2">
                  <label class="form-label">Address *</label>
                  <input type="text" class="form-control" id="editVenAddress" value="${escapeHtml(v.address||'')}">
                  <small class="text-danger d-none" id="errEditVenAddress"></small>
                </div>
                <div class="mb-2">
                  <label class="form-label">City *</label>
                  <input type="text" class="form-control" id="editVenCity" value="${escapeHtml(v.city||'')}">
                  <small class="text-danger d-none" id="errEditVenCity"></small>
                </div>
                <div class="mb-2">
                  <label class="form-label">Street</label>
                  <input type="text" class="form-control" id="editVenStreet" value="${escapeHtml(v.street||'')}">
                </div>
                <div class="row">
                  <div class="col-6 mb-2">
                    <label class="form-label">Latitude</label>
                    <input type="number" step="any" class="form-control" id="editVenLat" value="${v.latitude||''}">
                  </div>
                  <div class="col-6 mb-2">
                    <label class="form-label">Longitude</label>
                    <input type="number" step="any" class="form-control" id="editVenLng" value="${v.longitude||''}">
                  </div>
                </div>
                <div class="mb-2">
                  <label class="form-label">Description</label>
                  <textarea class="form-control" id="editVenDesc" rows="3">${escapeHtml(v.description||'')}</textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('modalEditVenue').remove()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEditVenue(${v.id})">Update Venue</button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
    }

    async function submitEditVenue(id) {
      const data = {
        name: document.getElementById('editVenName').value.trim(),
        address: document.getElementById('editVenAddress').value.trim(),
        city: document.getElementById('editVenCity').value.trim(),
        street: document.getElementById('editVenStreet').value.trim() || null,
        latitude: document.getElementById('editVenLat').value || null,
        longitude: document.getElementById('editVenLng').value || null,
        description: document.getElementById('editVenDesc').value.trim() || null,
      };

      try {
        await api.updateVenue(id, data);
        document.getElementById('modalEditVenue').remove();
        toast('Venue updated successfully', 'success');
        await loadOwnerVenues();
      } catch (e) {
        toast(e.message, 'error');
      }
    }

    // View Spaces Modal
    function openViewSpacesModal(venue) {
      const v = typeof venue === 'string' ? JSON.parse(venue) : venue;
      ownerState.selectedVenueId = v.id;
      ownerState.selectedVenue = v;

      const html = `
        <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.5)" id="modalViewSpaces">
          <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background:#0d1b2a;border:1px solid #1e3a5f">
              <div class="modal-header">
                <h5 class="modal-title">Spaces of ${escapeHtml(v.name)}</h5>
                <button type="button" class="btn-close btn-close-white" onclick="document.getElementById('modalViewSpaces').remove()"></button>
              </div>
              <div class="modal-body">
                <div class="d-flex justify-content-between mb-2">
                  <span class="muted">Manage spaces in this venue</span>
                  <button class="btn btn-sm btn-primary" onclick="openAddSpaceModal()">+ Add Space</button>
                </div>
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Capacity</th>
                        <th>Prices</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="modalSpaceRows">
                      <tr><td colspan="6" class="text-center">Loading...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
      loadModalSpaces(v.id);
    }

    async function loadModalSpaces(venueId) {
      try {
        const out = await api.ownerSpaces(venueId);
        const { items } = normalizeList(out);

        const tbody = document.getElementById('modalSpaceRows');
        tbody.innerHTML = '';

        if (items.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center muted">No spaces yet. Add one!</td></tr>';
          return;
        }

        items.forEach(s => {
          const spaceType = s.space_type || {};
          const prices = [
            s.price_per_hour ? `H: ${fmtMoney(s.price_per_hour)}` : null,
            s.price_per_day ? `D: ${fmtMoney(s.price_per_day)}` : null,
            s.price_per_month ? `M: ${fmtMoney(s.price_per_month)}` : null,
          ].filter(Boolean).join(', ') || '-';

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${s.id}</td>
            <td>${escapeHtml(s.name||'-')}</td>
            <td>${escapeHtml(spaceType.type_name||'-')}</td>
            <td>${s.capacity||'-'}</td>
            <td style="font-size:11px">${prices}</td>
            <td>
              <button class="btn btn-sm btn-outline-info" onclick="viewSpaceAmenities(${s.id})">\ud83c\udff7\ufe0f</button>
              <button class="btn btn-sm btn-outline-primary" onclick='openEditSpaceModal(${JSON.stringify(s)})'>Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteSpaceFromModal(${s.id})">Del</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        document.getElementById('modalSpaceRows').innerHTML =
          `<tr><td colspan="6" class="text-center text-danger">Error: ${escapeHtml(e.message)}</td></tr>`;
      }
    }

    // Add Space Modal
    function openAddSpaceModal() {
      if (!ownerState.selectedVenueId) {
        toast('Please select a venue first', 'error');
        return;
      }
      const html = `
        <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.5);z-index:1060" id="modalAddSpace">
          <div class="modal-dialog">
            <div class="modal-content" style="background:#0d1b2a;border:1px solid #1e3a5f">
              <div class="modal-header">
                <h5 class="modal-title">Add Space</h5>
                <button type="button" class="btn-close btn-close-white" onclick="document.getElementById('modalAddSpace').remove()"></button>
              </div>
              <div class="modal-body">
                <div class="mb-2">
                  <label class="form-label">Name *</label>
                  <input type="text" class="form-control" id="spcName">
                  <small class="text-danger d-none" id="errSpcName"></small>
                </div>
                <div class="mb-2">
                  <label class="form-label">Space Type *</label>
                  <select class="form-control" id="spcType">
                    <option value="1">Meeting Room</option>
                    <option value="2">Private Office</option>
                    <option value="3">Hot Desk</option>
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label">Capacity *</label>
                  <input type="number" min="1" class="form-control" id="spcCap" value="1">
                </div>
                <div class="row">
                  <div class="col-4 mb-2">
                    <label class="form-label">Price/Hour</label>
                    <input type="number" min="0" step="1000" class="form-control" id="spcPriceH">
                  </div>
                  <div class="col-4 mb-2">
                    <label class="form-label">Price/Day</label>
                    <input type="number" min="0" step="1000" class="form-control" id="spcPriceD">
                  </div>
                  <div class="col-4 mb-2">
                    <label class="form-label">Price/Month</label>
                    <input type="number" min="0" step="1000" class="form-control" id="spcPriceM">
                  </div>
                </div>
                <div class="row">
                  <div class="col-6 mb-2">
                    <label class="form-label">Open Hour</label>
                    <input type="time" class="form-control" id="spcOpen" value="08:00">
                  </div>
                  <div class="col-6 mb-2">
                    <label class="form-label">Close Hour</label>
                    <input type="time" class="form-control" id="spcClose" value="22:00">
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('modalAddSpace').remove()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAddSpace()">Create</button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
    }

    async function submitAddSpace() {
      const data = {
        name: document.getElementById('spcName').value.trim(),
        space_type_id: parseInt(document.getElementById('spcType').value),
        capacity: parseInt(document.getElementById('spcCap').value),
        price_per_hour: document.getElementById('spcPriceH').value || null,
        price_per_day: document.getElementById('spcPriceD').value || null,
        price_per_month: document.getElementById('spcPriceM').value || null,
        open_hour: document.getElementById('spcOpen').value || null,
        close_hour: document.getElementById('spcClose').value || null,
      };

      try {
        await api.createSpace(ownerState.selectedVenueId, data);
        document.getElementById('modalAddSpace').remove();
        toast('Space created!', 'success');
        await loadModalSpaces(ownerState.selectedVenueId);
        await loadOwnerVenues();
      } catch (e) {
        toast(e.message, 'error');
      }
    }

    // Edit Space Modal
    function openEditSpaceModal(space) {
      const s = typeof space === 'string' ? JSON.parse(space) : space;
      const html = `
        <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.5);z-index:1060" id="modalEditSpace">
          <div class="modal-dialog">
            <div class="modal-content" style="background:#0d1b2a;border:1px solid #1e3a5f">
              <div class="modal-header">
                <h5 class="modal-title">Edit Space</h5>
                <button type="button" class="btn-close btn-close-white" onclick="document.getElementById('modalEditSpace').remove()"></button>
              </div>
              <div class="modal-body">
                <div class="mb-2">
                  <label class="form-label">Name *</label>
                  <input type="text" class="form-control" id="editSpcName" value="${escapeHtml(s.name||'')}">
                </div>
                <div class="mb-2">
                  <label class="form-label">Capacity *</label>
                  <input type="number" min="1" class="form-control" id="editSpcCap" value="${s.capacity||1}">
                </div>
                <div class="row">
                  <div class="col-4 mb-2">
                    <label class="form-label">Price/Hour</label>
                    <input type="number" min="0" class="form-control" id="editSpcPriceH" value="${s.price_per_hour||''}">
                  </div>
                  <div class="col-4 mb-2">
                    <label class="form-label">Price/Day</label>
                    <input type="number" min="0" class="form-control" id="editSpcPriceD" value="${s.price_per_day||''}">
                  </div>
                  <div class="col-4 mb-2">
                    <label class="form-label">Price/Month</label>
                    <input type="number" min="0" class="form-control" id="editSpcPriceM" value="${s.price_per_month||''}">
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('modalEditSpace').remove()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEditSpace(${s.id})">Update</button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
    }

    async function submitEditSpace(id) {
      const data = {
        name: document.getElementById('editSpcName').value.trim(),
        capacity: parseInt(document.getElementById('editSpcCap').value),
        price_per_hour: document.getElementById('editSpcPriceH').value || null,
        price_per_day: document.getElementById('editSpcPriceD').value || null,
        price_per_month: document.getElementById('editSpcPriceM').value || null,
      };

      try {
        await api.updateSpace(id, data);
        document.getElementById('modalEditSpace').remove();
        toast('Space updated!', 'success');
        await loadModalSpaces(ownerState.selectedVenueId);
        await loadOwnerVenues();
      } catch (e) {
        toast(e.message, 'error');
      }
    }

    async function deleteSpaceFromModal(id) {
      if (!confirm('Delete this space?')) return;
      try {
        await api.deleteSpace(id);
        toast('Space deleted', 'success');
        await loadModalSpaces(ownerState.selectedVenueId);
        await loadOwnerVenues();
      } catch (e) {
        toast(e.message, 'error');
      }
    }

    // View Amenities
    async function viewSpaceAmenities(spaceId) {
      try {
        const out = await api.request(`/api/owner/spaces/${spaceId}/amenities`);
        const amenities = out?.data || [];

        if (amenities.length === 0) {
          toast('No amenities for this space', 'info');
          return;
        }

        const list = amenities.map(a => a.amenity_name || a.name).join(', ');
        toast(`Amenities: ${list}`, 'info', 5000);
      } catch (e) {
        toast(e.message, 'error');
      }
    }

    // Owner Venues table click handlers
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-act]');
      if (!btn) return;

      const tbody = btn.closest('#ownerVenueRows');
      if (!tbody) return;

      const action = btn.dataset.act;
      const id = btn.dataset.id;

      if (action === 'view-spaces') {
        const venue = btn.dataset.venue;
        openViewSpacesModal(venue);
      } else if (action === 'manage-managers') {
        const name = btn.dataset.name;
        ownerState.selectedVenueId = Number(id);
        ownerState.selectedVenue = ownerState.venues.find(v => v.id === Number(id));
        showOwnerTab('ownerManagers');
        await loadOwnerManagers(Number(id));
        toast(`Managers of: ${name}`, 'info');
      } else if (action === 'edit-venue') {
        const venue = btn.dataset.venue;
        openEditVenueModal(venue);
      } else if (action === 'delete-venue') {
        const name = btn.dataset.name;
        if (!confirm(`Delete venue "${name}"?`)) return;
        await deleteOwnerVenue(id);
      }
    });

    // Owner Spaces table click handlers (for main tab, not modal)
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-act]');
      if (!btn) return;

      const tbody = btn.closest('#ownerSpaceRows');
      if (!tbody) return;

      const action = btn.dataset.act;
      const id = btn.dataset.id;

      if (action === 'view-amenities') {
        await viewSpaceAmenities(id);
      } else if (action === 'edit-space') {
        const space = btn.dataset.space;
        openEditSpaceModal(space);
      } else if (action === 'delete-space') {
        const name = btn.dataset.name;
        if (!confirm(`Delete space "${name}"?`)) return;
        await deleteOwnerSpace(id);
      }
    });

    // Owner Managers table click handlers
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-act]');
      if (!btn) return;

      const tbody = btn.closest('#ownerManagerRows');
      if (!tbody) return;

      const action = btn.dataset.act;
      const id = btn.dataset.id;

      if (action === 'delete-manager') {
        const email = btn.dataset.email;
        if (!ownerState.selectedVenueId) {
          toast('No venue selected', 'error');
          return;
        }
        await deleteOwnerManager(ownerState.selectedVenueId, id, email);
      }
    });

    // Button click handlers
    document.getElementById('btnAddVenue')?.addEventListener('click', openAddVenueModal);
    document.getElementById('btnAddSpace')?.addEventListener('click', openAddSpaceModal);
    document.getElementById('btnBackToVenues')?.addEventListener('click', () => {
      ownerState.selectedVenueId = null;
      ownerState.selectedVenue = null;
      showOwnerTab('ownerVenues');
    });
    document.getElementById('btnAddManager')?.addEventListener('click', async () => {
      const email = document.getElementById('inputManagerEmail').value.trim();
      if (!email) {
        toast('Please enter manager email', 'error');
        return;
      }
      await addOwnerManager(ownerState.selectedVenueId, email);
    });

    // ====== INIT ======
    (async function init() {
      // Auth guard
      if (!getToken()) {
        window.location.replace('/login');
        return;
      }

      try {
        const out = await api.me();
        const u = out?.data?.user;
        if (!u) throw new Error('Invalid user');
        setUser(u);
        syncAuthUI();
        showTab('tabPublic');
        showAdminTab('adminStats');
        showOwnerTab('ownerBookings');
        showManagerTab('managerManagedVenues');
        await doSearch();
      } catch (err) {
        clearAuth();
        window.location.replace('/login');
      }
    })();
  </script>
</body>
</html>
